<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bookings | Hotel Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex">
  <!-- Sidebar -->
  <aside class="w-64 bg-gray-900 text-gray-100 min-h-screen">
    <div class="p-6 text-2xl font-bold border-b border-gray-700">üè® Admin Panel</div>
    <nav class="p-4 space-y-2">
      <a href="http://127.0.0.1:5000" class="block hover:bg-gray-800 px-4 py-2 rounded">üè† Dashboard</a>
      <a href="http://127.0.0.1:5000/guests" class="block hover:bg-gray-800 px-4 py-2 rounded">üë§ Guests</a>
      <a href="http://127.0.0.1:5000/rooms" class="block hover:bg-gray-800 px-4 py-2 rounded">üõèÔ∏è Rooms</a>
      <a href="http://127.0.0.1:5000/employees" class="block hover:bg-gray-800 px-4 py-2 rounded">üëî Employees</a>
      <a href="http://127.0.0.1:5000/bookings" class="block bg-gray-800 px-4 py-2 rounded">üìÖ Bookings</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-6">
    <h1 class="text-2xl font-semibold mb-4">Bookings</h1>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="p-4 mb-4 rounded {% if category == 'error' %}bg-red-500{% else %}bg-green-500{% endif %} text-white">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Booking Form -->
    <form method="POST" action="{{ url_for('bookings.handle_booking') }}" class="mb-6 bg-white p-4 rounded shadow">
      <h2 class="text-lg font-semibold mb-4">Create New Booking</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Guest Selection -->
        <div class="space-y-4">
          <h3 class="text-md font-semibold text-gray-700">Guest Information</h3>
          
          <!-- Guest Search -->
          <div>
            <label class="block text-sm text-gray-600 mb-2">Search Guest</label>
            <div class="relative">
              <input type="text" 
                     id="guestSearch" 
                     placeholder="Type guest name to search..."
                     class="border rounded p-2 w-full"
                     autocomplete="off">
              <div id="guestResults" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded shadow-lg hidden max-h-60 overflow-y-auto"></div>
            </div>
          </div>

          <!-- Guest ID Input -->
          <div>
            <label class="block text-sm text-gray-600">Guest ID</label>
            <input name="guest_id" 
                   id="guest_id" 
                   type="number" 
                   required 
                   class="border rounded p-2 w-full bg-gray-50"
                   readonly>
            <div id="selectedGuestInfo" class="text-sm text-gray-600 mt-1"></div>
          </div>
        </div>

        <!-- Room Selection -->
        <div class="space-y-4">
          <h3 class="text-md font-semibold text-gray-700">Room Information</h3>
          
          <div>
            <label class="block text-sm text-gray-600">Select Room</label>
            <select name="room_id" required class="border rounded p-2 w-full">
              <option value="">Select a room</option>
              {% for room in vacant_rooms %}
              <option value="{{ room.room_id }}">
                Room {{ room.room_id }} - {{ room.type_name }} (‚Ç±{{ room.rate_per_type }}/night)
              </option>
              {% endfor %}
            </select>
            <p class="text-xs text-gray-500 mt-1">Showing first 20 vacant rooms</p>
          </div>
        </div>

        <!-- Dates -->
        <div class="space-y-4">
          <h3 class="text-md font-semibold text-gray-700">Booking Dates</h3>
          
          <div>
            <label class="block text-sm text-gray-600">Start Date</label>
            <input name="start_date" type="date" required class="border rounded p-2 w-full">
          </div>

          <div>
            <label class="block text-sm text-gray-600">End Date</label>
            <input name="end_date" type="date" required class="border rounded p-2 w-full">
          </div>
        </div>
      </div>

      <div class="mt-6">
        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 w-full">
          Create Booking
        </button>
      </div>
    </form>

    <!-- Bookings Table -->
    <div class="bg-white rounded shadow">
      <div class="p-4 border-b">
        <h3 class="text-lg font-semibold">Existing Bookings</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Booking ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Guest</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Room</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Room Type</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Start Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">End Date</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {% for booking in bookings %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4">{{ booking.booking_id }}</td>
              <td class="px-6 py-4">{{ booking.guest_first_name }} {{ booking.guest_last_name }} (ID: {{ booking.guest_id }})</td>
              <td class="px-6 py-4">Room {{ booking.room_id }}</td>
              <td class="px-6 py-4">{{ booking.room_type }}</td>
              <td class="px-6 py-4">{{ booking.start_date }}</td>
              <td class="px-6 py-4">{{ booking.end_date }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    // Guest search functionality
    document.getElementById('guestSearch').addEventListener('input', function(e) {
      const query = e.target.value.trim();
      const resultsContainer = document.getElementById('guestResults');
      
      if (query.length < 2) {
        resultsContainer.classList.add('hidden');
        return;
      }
      
      fetch(`/bookings/search-guests?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(guests => {
          resultsContainer.innerHTML = '';
          
          if (guests.length === 0) {
            resultsContainer.innerHTML = '<div class="p-3 text-gray-500">No guests found</div>';
            resultsContainer.classList.remove('hidden');
            return;
          }
          
          guests.forEach(guest => {
            const guestElement = document.createElement('div');
            guestElement.className = 'p-3 border-b border-gray-200 hover:bg-gray-100 cursor-pointer';
            guestElement.innerHTML = `
              <div class="font-semibold">${guest.first_name} ${guest.last_name}</div>
              <div class="text-sm text-gray-600">ID: ${guest.guest_id} | ${guest.email_address}</div>
            `;
            
            guestElement.addEventListener('click', function() {
              document.getElementById('guest_id').value = guest.guest_id;
              document.getElementById('selectedGuestInfo').innerHTML = 
                `<strong>${guest.first_name} ${guest.last_name}</strong><br>
                 ${guest.email_address} | ${guest.contact_number}`;
              document.getElementById('guestSearch').value = '';
              resultsContainer.classList.add('hidden');
            });
            
            resultsContainer.appendChild(guestElement);
          });
          
          resultsContainer.classList.remove('hidden');
        })
        .catch(error => {
          console.error('Error searching guests:', error);
        });
    });
    
    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#guestSearch') && !e.target.closest('#guestResults')) {
        document.getElementById('guestResults').classList.add('hidden');
      }
    });
  </script>
</body>
</html>