<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Housekeeping Items | Hotel Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex">

  <!-- Sidebar -->
  <aside class="w-64 bg-gray-900 text-gray-100 min-h-screen">
    <div class="p-6 text-2xl font-bold border-b border-gray-700">üè® Admin Panel</div>
    <nav class="p-4 space-y-2">
      <a href="http://127.0.0.1:5000" class="block hover:bg-gray-800 px-4 py-2 rounded">üè† Dashboard</a>
      <a href="http://127.0.0.1:5000/guests" class="block hover:bg-gray-800 px-4 py-2 rounded">üë§ Guests</a>
      <a href="http://127.0.0.1:5000/rooms" class="block hover:bg-gray-800 px-4 py-2 rounded">üõèÔ∏è Rooms</a>
      <a href="http://127.0.0.1:5000/employees" class="block hover:bg-gray-800 px-4 py-2 rounded">üëî Employees</a>
      
      <!-- Housekeeping Section -->
      <div class="space-y-1">
        <a href="http://127.0.0.1:5000/housekeeping-items" class="block hover:bg-gray-800 px-4 py-2 rounded bg-gray-800 font-semibold">üßπ Housekeeping</a>
        <div class="ml-4 space-y-1">
          <a href="{{ url_for('housekeeping_items.housekeeping_items_page', tab='inventory') }}" class="block hover:bg-gray-700 px-4 py-2 rounded text-sm {% if not request.args.get('tab') or request.args.get('tab') == 'inventory' %}bg-gray-700{% endif %}">üì¶ Inventory Management</a>
          <a href="{{ url_for('housekeeping_items.housekeeping_items_page', tab='issuance') }}" class="block hover:bg-gray-700 px-4 py-2 rounded text-sm {% if request.args.get('tab') == 'issuance' %}bg-gray-700{% endif %}">üîÑ Item Issuance</a>
        </div>
      </div>
      
      <a href="http://127.0.0.1:5000/bookings" class="block hover:bg-gray-800 px-4 py-2 rounded">üìÖ Bookings</a>
      <a href="http://127.0.0.1:5000/gueststay" class="block hover:bg-gray-800 px-4 py-2 rounded">üõéÔ∏è Guest Stay</a>
      <a href="http://127.0.0.1:5000/payments" class="block hover:bg-gray-800 px-4 py-2 rounded">üí≥ Payments</a>
      <a href="http://127.0.0.1:5000/reports" class="block hover:bg-gray-800 px-4 py-2 rounded">üìä Reports</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-6">
    <!-- Navigation Tabs within Main Content -->
    <div class="mb-6 border-b border-gray-200">
      <nav class="-mb-px flex space-x-8">
        <a href="{{ url_for('housekeeping_items.housekeeping_items_page', tab='inventory') }}" 
           class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {% if not request.args.get('tab') or request.args.get('tab') == 'inventory' %}border-blue-500 text-blue-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %}">
          üì¶ Inventory Management
        </a>
        <a href="{{ url_for('housekeeping_items.housekeeping_items_page', tab='issuance') }}" 
           class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {% if request.args.get('tab') == 'issuance' %}border-blue-500 text-blue-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %}">
          üîÑ Item Issuance
        </a>
      </nav>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="mb-4 p-4 rounded {% if category == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Inventory Management Tab Content -->
    {% if not request.args.get('tab') or request.args.get('tab') == 'inventory' %}
    <div id="inventory-content">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-semibold">Housekeeping Inventory</h1>
        {% if not editing and not viewing_item %}
        <a href="{{ url_for('housekeeping_items.housekeeping_items_page', tab='inventory', edit='new') }}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
          + Add New Item
        </a>
        {% endif %}
      </div>

      <!-- Low Stock Alert Banner -->
      {% if low_stock_items and low_stock_items|length > 0 and not viewing_item %}
      <div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <span class="text-red-600 text-xl">‚ö†Ô∏è</span>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800">
              Low Stock Alert
            </h3>
            <div class="mt-1 text-sm text-red-700">
              <p>
                You have <strong>{{ low_stock_items|length }}</strong> item(s) that need to be restocked.
              </p>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Add/Edit Form -->
      {% if editing and not viewing_item %}
      <div class="bg-white p-6 rounded shadow mb-6">
        <h2 class="text-lg font-semibold mb-4">
          {% if editing.housekeeping_item_id %}Edit Item #{{ editing.housekeeping_item_id }}{% else %}Add New Housekeeping Item{% endif %}
        </h2>
        <form action="{{ url_for('housekeeping_items.housekeeping_items_page') }}" method="POST" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {% if editing.housekeeping_item_id %}
          <input type="hidden" name="housekeeping_item_id" value="{{ editing.housekeeping_item_id }}">
          {% endif %}

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
            <input type="text" name="item_name" value="{{ editing.item_name or '' }}" class="w-full px-3 py-2 border border-gray-300 rounded" required placeholder="Enter item name">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Cost per Unit</label>
            <input type="number" name="cost_per_unit" step="0.01" min="0" value="{{ editing.cost_per_unit or '' }}" class="w-full px-3 py-2 border border-gray-300 rounded" required placeholder="0.00">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Current Stock</label>
            <input type="number" name="current_stock" min="0" value="{{ editing.current_stock or '' }}" class="w-full px-3 py-2 border border-gray-300 rounded" required placeholder="0">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Minimum Stock</label>
            <input type="number" name="minimum_stock" min="0" value="{{ editing.minimum_stock or '' }}" class="w-full px-3 py-2 border border-gray-300 rounded" required placeholder="0">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Max Storage</label>
            <input type="number" name="max_stock_storage" min="1" value="{{ editing.max_stock_storage or '' }}" class="w-full px-3 py-2 border border-gray-300 rounded" required placeholder="100">
          </div>

          <div class="md:col-span-2 flex space-x-2">
            <button type="submit" name="action" value="save" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
              {% if editing.housekeeping_item_id %}Update Item{% else %}Add Item{% endif %}
            </button>
            <a href="{{ url_for('housekeeping_items.housekeeping_items_page', tab='inventory') }}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">Cancel</a>
          </div>
        </form>
      </div>
      {% endif %}

      <!-- Items Table -->
      {% if not viewing_item %}
      <div class="overflow-x-auto bg-white rounded shadow">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost per Unit</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Stock</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Minimum Stock</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max Storage</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for item in housekeeping_items %}
            <tr class="{% if item.current_stock <= item.minimum_stock %}bg-red-50{% endif %}">
              <td class="px-6 py-4 whitespace-nowrap">{{ item.housekeeping_item_id }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ item.item_name }}</td>
              <td class="px-6 py-4 whitespace-nowrap">‚Ç±{{ "%.2f"|format(item.cost_per_unit) }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="{% if item.current_stock <= item.minimum_stock %}text-red-600 font-semibold{% endif %}">
                  {{ item.current_stock }}
                  {% if item.current_stock <= item.minimum_stock %}(Low Stock){% endif %}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">{{ item.minimum_stock }}</td>
              <td class="px-6 py-4 whitespace-nowrap">{{ item.max_stock_storage }}</td>
              <td class="px-6 py-4 whitespace-nowrap space-x-2">
                <!-- View Details Link -->
                <a href="{{ url_for('housekeeping_items.housekeeping_items_page', tab='inventory', view_item=item.housekeeping_item_id) }}" 
                   class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm">View</a>
                
                <!-- Edit Link -->
                <a href="{{ url_for('housekeeping_items.housekeeping_items_page', tab='inventory', edit=item.housekeeping_item_id) }}" 
                   class="bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700 text-sm">Edit</a>
                
                <!-- Delete Button -->
                <form method="POST" action="{{ url_for('housekeeping_items.housekeeping_items_page') }}" style="display:inline;">
                  <input type="hidden" name="housekeeping_item_id" value="{{ item.housekeeping_item_id }}">
                  <input type="hidden" name="action" value="delete">
                  <button type="submit" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 text-sm" 
                          onclick="return confirm('Delete this item?')">Delete</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <!-- Item Details Section (Shows when viewing specific item) -->
      {% if viewing_item %}
      <div id="item-details-content" class="mt-8">
        <div class="mb-6">
          <a href="{{ url_for('housekeeping_items.housekeeping_items_page', tab='inventory') }}" 
             class="text-blue-600 hover:text-blue-800 mb-4 inline-block">‚Üê Back to Inventory</a>
          <h2 class="text-2xl font-semibold">Item Details: {{ viewing_item.item_name }}</h2>
        </div>

        <!-- Item Details Card -->
        <div class="bg-white rounded-lg shadow mb-6">
          <div class="p-6 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800">Item Information</h3>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-600">Item ID</label>
                <p class="mt-1 text-lg font-semibold">{{ viewing_item.housekeeping_item_id }}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600">Item Name</label>
                <p class="mt-1 text-lg font-semibold">{{ viewing_item.item_name }}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600">Unit Cost</label>
                <p class="mt-1 text-lg font-semibold">‚Ç±{{ "%.2f"|format(viewing_item.cost_per_unit) }}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600">Stock Remaining</label>
                <p class="mt-1 text-lg font-semibold">{{ viewing_item.current_stock }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Issuance History -->
        <div class="bg-white rounded-lg shadow">
          <div class="p-6 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800">Issuance History</h3>
          </div>
          
          {% if viewing_item.issuance_history %}
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Issued</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issued To Employee</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issued By Employee</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remarks</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {% for issuance in viewing_item.issuance_history %}
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap">
                    {{ issuance.date_issued.strftime('%Y-%m-%d %H:%M:%S') if issuance.date_issued }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="font-semibold">{{ issuance.quantity_issued }}</span>
                  </td>
                  
                  <!-- Issued To Employee -->
                  <td class="px-6 py-4">
                    <div class="text-sm">
                      <p class="font-semibold">{{ issuance.receiver_first_name }} {{ issuance.receiver_last_name }}</p>
                      <p class="text-gray-500">ID: {{ issuance.receiver_id }}</p>
                      <p class="text-gray-500">Position: {{ issuance.receiver_position|title }}</p>
                      <p class="text-gray-500">Status: {{ issuance.receiver_status|replace('-', ' ')|title }}</p>
                    </div>
                  </td>
                  
                  <!-- Issued By Employee -->
                  <td class="px-6 py-4">
                    <div class="text-sm">
                      <p class="font-semibold">{{ issuance.issuer_first_name }} {{ issuance.issuer_last_name }}</p>
                      <p class="text-gray-500">ID: {{ issuance.issuer_id }}</p>
                      <p class="text-gray-500">Position: {{ issuance.issuer_position|title }}</p>
                      <p class="text-gray-500">Status: {{ issuance.issuer_status|replace('-', ' ')|title }}</p>
                    </div>
                  </td>
                  
                  <td class="px-6 py-4">
                    <p class="text-sm text-gray-600">{{ issuance.remarks or 'No remarks' }}</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="p-8 text-center">
            <p class="text-gray-500 text-lg">No issuance history found for this item.</p>
            <p class="text-gray-400 mt-2">This item has not been issued to any employees yet.</p>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Item Issuance Tab Content -->
    {% if request.args.get('tab') == 'issuance' %}
    <div id="issuance-content">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-semibold">Housekeeping Item Issuance</h1>
        <span class="text-sm text-gray-500">Issue items to housekeeping staff</span>
      </div>

      <!-- Item Issuance Form -->
      <div class="bg-white p-6 rounded shadow mb-6">
        <h2 class="text-lg font-semibold mb-4">Issue Items to Employee</h2>

        <form action="{{ url_for('housekeeping_items.handle_item_issuance') }}" method="POST" class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Item</label>
            <select name="housekeeping_item_id" class="w-full px-3 py-2 border border-gray-300 rounded" required>
              <option value="">Select Item</option>
              {% for item in housekeeping_items %}
              <option value="{{ item.housekeeping_item_id }}" 
                      data-stock="{{ item.current_stock }}"
                      {% if item.current_stock <= 0 %}disabled{% endif %}>
                {{ item.item_name }} (Stock: {{ item.current_stock }})
              </option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
            <input type="number" name="quantity_issued" min="1" class="w-full px-3 py-2 border border-gray-300 rounded" required 
                  placeholder="Enter quantity">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Employee (Receiver)</label>
            <select name="employee_id" class="w-full px-3 py-2 border border-gray-300 rounded" required>
              <option value="">Select Employee</option>
              {% for employee in employees %}
              <option value="{{ employee.employee_id }}">
                {{ employee.first_name }} {{ employee.last_name }} - {{ employee.emp_position }} ({{ employee.emp_status }})
              </option>
              {% endfor %}
            </select>
            {% if not employees %}
            <p class="text-sm text-red-600 mt-1">No active housekeeping staff available.</p>
            {% endif %}
          </div>

          <!-- Issuer Field -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Issued By (Admin)</label>
            <select name="issuer_id" class="w-full px-3 py-2 border border-gray-300 rounded" required>
              <option value="">Select Issuer</option>
              {% for admin in admin_employees %}
              <option value="{{ admin.employee_id }}">
                {{ admin.first_name }} {{ admin.last_name }} - {{ admin.emp_position }} ({{ admin.emp_status }})
              </option>
              {% endfor %}
            </select>
            {% if not admin_employees %}
            <p class="text-sm text-red-600 mt-1">No active admin staff available.</p>
            {% endif %}
          </div>

          <!-- Remarks Field -->
          <div class="md:col-span-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Remarks (Optional)</label>
            <textarea name="remarks" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded" 
                      placeholder="Add any notes or remarks about this issuance..."></textarea>
          </div>

          <div class="md:col-span-3">
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded font-medium">
              üì§ Issue Items
            </button>
          </div>
        </form>
      </div>

      <!-- Issuance History Table -->
      <div class="mt-8">
        <h2 class="text-xl font-semibold mb-4">Issuance History</h2>
        <div class="overflow-x-auto bg-white rounded shadow">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issuance ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee (Receiver)</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issued By</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Issued</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remarks</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for issuance in issuance_history %}
              <tr>
                <td class="px-6 py-4 whitespace-nowrap">{{ issuance.issuance_id }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ issuance.item_name }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ issuance.quantity_issued }}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                  {{ issuance.employee_name }} 
                  {% if issuance.employee_position %}({{ issuance.employee_position }}){% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  {{ issuance.issuer_name }} 
                  {% if issuance.issuer_position %}({{ issuance.issuer_position }}){% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">{{ issuance.date_issued.strftime('%Y-%m-%d %H:%M') if issuance.date_issued else 'N/A' }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                  {{ issuance.remarks or '-' }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <!-- Delete Issuance Button -->
                  <form method="POST" action="{{ url_for('housekeeping_items.delete_issuance') }}" style="display:inline;">
                    <input type="hidden" name="issuance_id" value="{{ issuance.issuance_id }}">
                    <button type="submit" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 text-sm" 
                            onclick="return confirm('Delete this issuance record? The stock will be restored to the item.')">Delete</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}
  </main>

  <script>
    document.querySelector('select[name="housekeeping_item_id"]')?.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const maxStock = selectedOption.getAttribute('data-stock');
      const quantityInput = document.querySelector('input[name="quantity_issued"]');
      if (quantityInput && maxStock) {
        quantityInput.setAttribute('max', maxStock);
        quantityInput.setAttribute('placeholder', `Max: ${maxStock}`);
      }
    });
  </script>

</body>
</html>